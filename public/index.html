<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Archipel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #0e1117;
  --surface:  #161b24;
  --surface2: #1c2333;
  --border:   #252d3d;
  --blue:     #4f8ef7;
  --blue-dim: rgba(79,142,247,0.12);
  --green:    #3dd68c;
  --green-dim:rgba(61,214,140,0.1);
  --red:      #f75555;
  --text:     #e2e8f4;
  --text-2:   #7a8aa0;
  --text-3:   #3d4d63;
  --radius:   12px;
  --radius-sm:8px;
  --shadow:   0 8px 32px rgba(0,0,0,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }

body {
  font-family: 'Sora', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  line-height: 1.5;
}

/* â”€â”€ PAGES â”€â”€ */
.page { display: none; height: 100vh; }
.page.active { display: flex; }

/* â”€â”€ ONBOARDING â”€â”€ */
#page-onboarding {
  align-items: center;
  justify-content: center;
  flex-direction: column;
  background: radial-gradient(ellipse at 50% 0%, rgba(79,142,247,0.08) 0%, transparent 70%);
}

.onboarding-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 48px;
  width: 440px;
  box-shadow: var(--shadow);
}

.brand {
  text-align: center;
  margin-bottom: 36px;
}

.brand-logo {
  width: 52px;
  height: 52px;
  background: var(--blue-dim);
  border: 1.5px solid var(--blue);
  border-radius: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin-bottom: 16px;
}

.brand h1 {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.5px;
  margin-bottom: 6px;
}

.brand p {
  color: var(--text-2);
  font-size: 13px;
  font-weight: 300;
}

/* Tabs switch */
.auth-tabs {
  display: flex;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1;
  padding: 9px;
  text-align: center;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-2);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
}

.auth-tab.active {
  background: var(--surface2);
  color: var(--text);
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

/* Form */
.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-2);
  margin-bottom: 8px;
  letter-spacing: 0.3px;
}

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.form-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 11px 14px;
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.12);
}

.form-input::placeholder { color: var(--text-3); }

.btn-main {
  width: 100%;
  padding: 13px;
  background: var(--blue);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.1s;
  margin-top: 8px;
}

.btn-main:hover { opacity: 0.9; }
.btn-main:active { transform: scale(0.99); }
.btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

.error-msg {
  color: var(--red);
  font-size: 12px;
  margin-top: 12px;
  text-align: center;
  min-height: 18px;
}

/* â”€â”€ APP LAYOUT â”€â”€ */
#page-app {
  flex-direction: row;
  height: 100vh;
  overflow: hidden;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: 280px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.sidebar-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
}

.user-card {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 600;
  flex-shrink: 0;
}

.avatar-me { background: var(--blue-dim); color: var(--blue); border: 1.5px solid var(--blue); }
.avatar-peer { background: var(--green-dim); color: var(--green); border: 1.5px solid rgba(61,214,140,0.3); }
.avatar-offline { background: rgba(122,138,160,0.1); color: var(--text-2); border: 1.5px solid var(--border); }

.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-status { font-size: 11px; color: var(--text-2); display: flex; align-items: center; gap: 4px; }
.status-dot-green { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }
.status-dot-gray { width: 6px; height: 6px; border-radius: 50%; background: var(--text-3); }

.network-badge {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  font-size: 12px;
  color: var(--text-2);
}

.network-badge span { color: var(--green); font-weight: 600; }

/* Sidebar sections */
.sidebar-section { padding: 12px 12px 0; }
.sidebar-section-label {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 1px;
  color: var(--text-3);
  text-transform: uppercase;
  padding: 0 8px;
  margin-bottom: 6px;
}

.peer-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.15s;
}

.peer-row:hover { background: var(--surface2); }
.peer-row.active { background: var(--blue-dim); }

.peer-name { font-size: 13px; font-weight: 500; flex: 1; }
.peer-status-text { font-size: 11px; color: var(--text-2); }

.no-peers-msg {
  padding: 20px 8px;
  text-align: center;
  color: var(--text-3);
  font-size: 12px;
  line-height: 1.8;
}

/* Sidebar bottom actions */
.sidebar-actions {
  margin-top: auto;
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.btn-icon {
  flex: 1;
  padding: 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-2);
  font-size: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s;
  font-family: 'Sora', sans-serif;
}

.btn-icon:hover { background: var(--border); color: var(--text); }
.btn-icon.active-tab { background: var(--blue-dim); color: var(--blue); border-color: var(--blue); }

/* â”€â”€ MAIN CONTENT â”€â”€ */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  overflow: hidden;
}

/* â”€â”€ CHAT VIEW â”€â”€ */
.chat-view {
  display: none;
  flex-direction: column;
  height: 100%;
}

.chat-view.visible { display: flex; }

.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--surface);
}

.chat-header-info h2 { font-size: 15px; font-weight: 600; }
.chat-header-info p { font-size: 12px; color: var(--text-2); }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.msg-bubble {
  display: flex;
  flex-direction: column;
  max-width: 65%;
}

.msg-bubble.me { align-self: flex-end; align-items: flex-end; }
.msg-bubble.them { align-self: flex-start; align-items: flex-start; }

.bubble {
  padding: 11px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  word-break: break-word;
}

.msg-bubble.me .bubble {
  background: var(--blue);
  color: white;
  border-bottom-right-radius: 4px;
}

.msg-bubble.them .bubble {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.bubble-meta {
  font-size: 10px;
  color: var(--text-3);
  margin-top: 4px;
  padding: 0 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.encrypted-badge {
  font-size: 9px;
  background: var(--green-dim);
  color: var(--green);
  padding: 1px 6px;
  border-radius: 20px;
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  display: flex;
  gap: 10px;
  align-items: center;
}

.chat-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 11px 18px;
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}

.chat-input:focus { border-color: var(--blue); }
.chat-input::placeholder { color: var(--text-3); }

.btn-send {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--blue);
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: opacity 0.2s;
}

.btn-send:hover { opacity: 0.85; }

/* â”€â”€ FILES VIEW â”€â”€ */
.files-view {
  display: none;
  flex-direction: column;
  height: 100%;
  padding: 28px;
  overflow-y: auto;
}

.files-view.visible { display: flex; }

.view-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 6px;
}

.view-subtitle {
  color: var(--text-2);
  font-size: 13px;
  margin-bottom: 28px;
}

/* Share zone */
.share-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 40px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 28px;
}

.share-zone:hover, .share-zone.drag-over {
  border-color: var(--blue);
  background: var(--blue-dim);
}

.share-zone-icon { font-size: 32px; margin-bottom: 12px; }
.share-zone-title { font-weight: 600; margin-bottom: 6px; }
.share-zone-sub { color: var(--text-2); font-size: 13px; }

#fileInputHidden { display: none; }

.section-title {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  color: var(--text-3);
  margin-bottom: 14px;
}

.files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  margin-bottom: 28px;
}

.file-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.file-card:hover { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(79,142,247,0.08); }

.file-card-icon { font-size: 28px; margin-bottom: 10px; }
.file-card-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-card-meta { font-size: 11px; color: var(--text-2); }
.file-card-owner { font-size: 11px; color: var(--blue); margin-top: 8px; }

.badge-local {
  position: absolute;
  top: 10px; right: 10px;
  font-size: 9px;
  background: var(--green-dim);
  color: var(--green);
  padding: 2px 8px;
  border-radius: 20px;
  font-weight: 600;
}

.badge-network {
  position: absolute;
  top: 10px; right: 10px;
  font-size: 9px;
  background: var(--blue-dim);
  color: var(--blue);
  padding: 2px 8px;
  border-radius: 20px;
  font-weight: 600;
}

/* Download progress */
.download-progress {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 12px;
  display: none;
}

.download-progress.visible { display: block; }
.download-filename { font-weight: 600; font-size: 13px; margin-bottom: 10px; }
.progress-track { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--green));
  border-radius: 3px;
  transition: width 0.4s;
  width: 0%;
}
.progress-label { font-size: 11px; color: var(--text-2); margin-top: 6px; }

/* â”€â”€ AI VIEW â”€â”€ */
.ai-view {
  display: none;
  flex-direction: column;
  height: 100%;
}

.ai-view.visible { display: flex; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-2);
  text-align: center;
  padding: 40px;
}

.empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
.empty-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.empty-sub { font-size: 13px; line-height: 1.7; }

/* â”€â”€ TOAST â”€â”€ */
.toasts {
  position: fixed;
  bottom: 24px;
  right: 24px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 9999;
}

.toast {
  padding: 12px 18px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  font-weight: 500;
  animation: toast-in 0.3s ease;
  box-shadow: var(--shadow);
}

.toast-success { background: var(--green-dim); color: var(--green); border: 1px solid rgba(61,214,140,0.3); }
.toast-error { background: rgba(247,85,85,0.1); color: var(--red); border: 1px solid rgba(247,85,85,0.3); }
.toast-info { background: var(--blue-dim); color: var(--blue); border: 1px solid rgba(79,142,247,0.3); }

@keyframes toast-in {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 100;
  align-items: center;
  justify-content: center;
}

.modal-overlay.visible { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
  width: 380px;
  box-shadow: var(--shadow);
}

.modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
.modal p { color: var(--text-2); font-size: 13px; margin-bottom: 20px; }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

.btn-secondary {
  padding: 10px 20px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 13px;
  cursor: pointer;
}

.btn-primary-sm {
  padding: 10px 20px;
  background: var(--blue);
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-family: 'Sora', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 1 â€” ONBOARDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-onboarding">
  <div class="onboarding-card">
    <div class="brand">
      <div class="brand-logo">ğŸï¸</div>
      <h1>Archipel</h1>
      <p>RÃ©seau privÃ©, chiffrÃ©, sans serveur central</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchAuthTab('register')">Rejoindre</div>
      <div class="auth-tab" onclick="switchAuthTab('login')">Se connecter</div>
    </div>

    <!-- Formulaire inscription -->
    <div id="form-register">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">PrÃ©nom</label>
          <input class="form-input" id="reg-firstname" type="text" placeholder="Alice">
        </div>
        <div class="form-group">
          <label class="form-label">Nom</label>
          <input class="form-input" id="reg-lastname" type="text" placeholder="Dupont">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input class="form-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn-main" id="btn-register" onclick="register()">CrÃ©er mon identitÃ© et rejoindre</button>
      <div class="error-msg" id="reg-error"></div>
    </div>

    <!-- Formulaire connexion -->
    <div id="form-login" style="display:none">
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input class="form-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter') login()">
      </div>
      <button class="btn-main" onclick="login()">Rejoindre le rÃ©seau</button>
      <div class="error-msg" id="login-error"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE 2 â€” APPLICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-app">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="user-card">
        <div class="avatar avatar-me" id="myAvatar">?</div>
        <div class="user-info">
          <div class="user-name" id="myName">â€”</div>
          <div class="user-status">
            <span class="status-dot-green"></span>
            ConnectÃ© au rÃ©seau
          </div>
        </div>
      </div>
      <div class="network-badge">
        <span>ğŸŒ RÃ©seau local</span>
        <span id="peerCountBadge">0 pairs</span>
      </div>
    </div>

    <div class="sidebar-section" style="flex:1; overflow-y:auto;">
      <div class="sidebar-section-label">Sur le rÃ©seau</div>
      <div id="peerListSidebar">
        <div class="no-peers-msg">
          ğŸ” Recherche de personnes<br>sur votre rÃ©seau...
        </div>
      </div>
    </div>

    <div class="sidebar-actions">
      <button class="btn-icon active-tab" id="btn-tab-chat" onclick="showView('chat-empty')">
        ğŸ’¬ Messages
      </button>
      <button class="btn-icon" id="btn-tab-files" onclick="showView('files')">
        ğŸ“ Fichiers
      </button>
      <button class="btn-icon" id="btn-tab-ai" onclick="showView('ai')">
        âœ¨ IA
      </button>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="main-content">

    <!-- Ã‰tat vide chat -->
    <div class="empty-state" id="view-chat-empty" style="display:flex">
      <div class="empty-icon">ğŸ’¬</div>
      <div class="empty-title">Vos messages</div>
      <div class="empty-sub">SÃ©lectionnez une personne<br>dans la liste pour commencer</div>
    </div>

    <!-- Vue chat -->
    <div class="chat-view" id="view-chat">
      <div class="chat-header">
        <div class="avatar avatar-peer" id="chatAvatar">?</div>
        <div class="chat-header-info">
          <h2 id="chatName">â€”</h2>
          <p>Chiffrement de bout en bout activÃ© ğŸ”</p>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="empty-state" style="flex:1">
          <div class="empty-icon">ğŸ”</div>
          <div class="empty-sub">Les messages sont chiffrÃ©s.<br>Personne d'autre ne peut les lire.</div>
        </div>
      </div>
      <div class="chat-input-area">
        <input class="chat-input" id="chatInput" type="text" placeholder="Votre message..."
          onkeydown="if(event.key==='Enter') sendMessage()">
        <button class="btn-send" onclick="sendMessage()">â¤</button>
      </div>
    </div>

    <!-- Vue fichiers -->
    <div class="files-view" id="view-files">
      <div class="view-title">Partage de fichiers</div>
      <div class="view-subtitle">Partagez et recevez des fichiers avec les personnes sur le rÃ©seau</div>

      <!-- Zone de partage -->
      <div class="share-zone" id="shareZone"
        onclick="document.getElementById('fileInputHidden').click()"
        ondragover="event.preventDefault(); this.classList.add('drag-over')"
        ondragleave="this.classList.remove('drag-over')"
        ondrop="handleDrop(event)">
        <div class="share-zone-icon">ğŸ“¤</div>
        <div class="share-zone-title">DÃ©poser un fichier ici</div>
        <div class="share-zone-sub">ou cliquer pour sÃ©lectionner</div>
      </div>
      <input type="file" id="fileInputHidden" onchange="handleFileSelect(event)">

      <!-- Progression -->
      <div class="download-progress" id="downloadProgress">
        <div class="download-filename" id="downloadFilename">TÃ©lÃ©chargement...</div>
        <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-label" id="progressLabel">DÃ©marrage...</div>
      </div>

      <!-- Fichiers disponibles sur le rÃ©seau -->
      <div class="section-title">Disponibles sur le rÃ©seau</div>
      <div class="files-grid" id="networkFilesGrid">
        <div class="no-peers-msg" style="grid-column:1/-1">Aucun fichier partagÃ© sur le rÃ©seau</div>
      </div>

      <!-- Mes fichiers partagÃ©s -->
      <div class="section-title">Mes fichiers partagÃ©s</div>
      <div class="files-grid" id="localFilesGrid">
        <div class="no-peers-msg" style="grid-column:1/-1">Vous n'avez pas encore partagÃ© de fichier</div>
      </div>
    </div>

    <!-- Vue IA -->
    <div class="ai-view" id="view-ai">
      <div class="chat-header">
        <div class="avatar" style="background:rgba(168,85,247,0.1);color:#a855f7;border:1.5px solid rgba(168,85,247,0.4)">âœ¨</div>
        <div class="chat-header-info">
          <h2>Assistant IA</h2>
          <p>Posez n'importe quelle question</p>
        </div>
      </div>
      <div class="chat-messages" id="aiMessages">
        <div class="msg-bubble them">
          <div class="bubble">Bonjour ! Je suis votre assistant intÃ©grÃ©. Posez-moi n'importe quelle question sur le rÃ©seau ou autre chose.</div>
          <div class="bubble-meta">Assistant Â· maintenant</div>
        </div>
      </div>
      <div class="chat-input-area">
        <input class="chat-input" id="aiInput" type="text" placeholder="Votre question..."
          onkeydown="if(event.key==='Enter') askAI()">
        <button class="btn-send" onclick="askAI()">â¤</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal confirmation tÃ©lÃ©chargement -->
<div class="modal-overlay" id="downloadModal">
  <div class="modal">
    <h3>TÃ©lÃ©charger ce fichier ?</h3>
    <p id="downloadModalDesc">â€”</p>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn-primary-sm" onclick="confirmDownload()">TÃ©lÃ©charger</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
  // â”€â”€ Ã‰tat global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let currentUser = null;
  let selectedPeer = null;
  let allPeers = [];
  let pendingDownload = null;

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type = 'info') {
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.textContent = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }

  // â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t, i) => {
      t.classList.toggle('active', ['register','login'][i] === tab);
    });
    document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
    document.getElementById('form-login').style.display = tab === 'login' ? 'block' : 'none';
  }

  async function register() {
    const firstName = document.getElementById('reg-firstname').value.trim();
    const lastName = document.getElementById('reg-lastname').value.trim();
    const password = document.getElementById('reg-password').value;
    const errEl = document.getElementById('reg-error');
    const btn = document.getElementById('btn-register');

    if (!firstName || !lastName || !password) {
      errEl.textContent = 'Tous les champs sont requis';
      return;
    }
    if (password.length < 6) {
      errEl.textContent = 'Mot de passe trop court (6 caractÃ¨res min.)';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'CrÃ©ation de votre identitÃ©...';
    errEl.textContent = '';

    try {
      const res = await fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ firstName, lastName, password })
      });
      const data = await res.json();

      if (data.success) {
        currentUser = data.displayName;
        enterApp(currentUser);
      } else {
        errEl.textContent = data.error || 'Erreur';
        btn.disabled = false;
        btn.textContent = 'CrÃ©er mon identitÃ© et rejoindre';
      }
    } catch (e) {
      errEl.textContent = 'Impossible de contacter le serveur';
      btn.disabled = false;
      btn.textContent = 'CrÃ©er mon identitÃ© et rejoindre';
    }
  }

  async function login() {
    const password = document.getElementById('login-password').value;
    const errEl = document.getElementById('login-error');

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      const data = await res.json();

      if (data.success) {
        currentUser = data.displayName;
        enterApp(currentUser);
      } else {
        errEl.textContent = data.error || 'Mot de passe incorrect';
      }
    } catch (e) {
      errEl.textContent = 'Impossible de contacter le serveur';
    }
  }

  function enterApp(displayName) {
    document.getElementById('page-onboarding').classList.remove('active');
    document.getElementById('page-app').classList.add('active');
    document.getElementById('myName').textContent = displayName;
    document.getElementById('myAvatar').textContent = displayName.charAt(0).toUpperCase();
    toast(`Bienvenue, ${displayName} ! ğŸ‘‹`, 'success');
    startPolling();
  }

  // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showView(view) {
    // Masquer tout
    ['chat-empty', 'chat', 'files', 'ai'].forEach(v => {
      const el = document.getElementById('view-' + v);
      if (el) { el.style.display = 'none'; if (el.classList) el.classList.remove('visible'); }
    });
    // Tabs
    ['btn-tab-chat', 'btn-tab-files', 'btn-tab-ai'].forEach(id =>
      document.getElementById(id)?.classList.remove('active-tab')
    );

    if (view === 'chat-empty') {
      document.getElementById('view-chat-empty').style.display = 'flex';
      document.getElementById('btn-tab-chat').classList.add('active-tab');
    } else if (view === 'chat') {
      document.getElementById('view-chat').classList.add('visible');
      document.getElementById('btn-tab-chat').classList.add('active-tab');
    } else if (view === 'files') {
      document.getElementById('view-files').classList.add('visible');
      document.getElementById('btn-tab-files').classList.add('active-tab');
      refreshFiles();
    } else if (view === 'ai') {
      document.getElementById('view-ai').classList.add('visible');
      document.getElementById('btn-tab-ai').classList.add('active-tab');
    }
  }

  // â”€â”€ SÃ©lectionner un pair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selectPeer(peer) {
    selectedPeer = peer;
    showView('chat');

    document.getElementById('chatName').textContent = peer.displayName;
    document.getElementById('chatAvatar').textContent = peer.displayName.charAt(0).toUpperCase();
    document.getElementById('chatAvatar').className = 'avatar ' + (peer.online ? 'avatar-peer' : 'avatar-offline');

    // Mettre en Ã©vidence dans la sidebar
    document.querySelectorAll('.peer-row').forEach(r => r.classList.remove('active'));
    document.getElementById('peer-' + peer.nodeId)?.classList.add('active');

    loadMessages(peer.nodeId);
  }

  // â”€â”€ RafraÃ®chir le rÃ©seau â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function refreshNetwork() {
    try {
      const res = await fetch('/api/network');
      const data = await res.json();

      allPeers = data.peers;
      const count = allPeers.length;

      document.getElementById('peerCountBadge').textContent =
        count === 0 ? '0 pair' : `${count} pair${count > 1 ? 's' : ''}`;

      const sidebar = document.getElementById('peerListSidebar');
      if (count === 0) {
        sidebar.innerHTML = `<div class="no-peers-msg">ğŸ” Recherche de personnes<br>sur votre rÃ©seau...</div>`;
      } else {
        sidebar.innerHTML = allPeers.map(p => `
          <div class="peer-row" id="peer-${p.nodeId}" onclick='selectPeer(${JSON.stringify(p)})'>
            <div class="avatar ${p.online ? 'avatar-peer' : 'avatar-offline'}" style="width:34px;height:34px;font-size:13px">
              ${p.displayName.charAt(0).toUpperCase()}
            </div>
            <div>
              <div class="peer-name">${p.displayName}</div>
              <div class="peer-status-text">${p.online ? 'ğŸŸ¢ En ligne' : 'âš« Hors ligne'}</div>
            </div>
          </div>
        `).join('');
      }
    } catch (e) {}
  }

  // â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let lastMsgCount = 0;

  async function loadMessages(nodeId) {
    try {
      const res = await fetch(`/api/chat/${nodeId}`);
      const msgs = await res.json();

      if (msgs.length === lastMsgCount && nodeId === selectedPeer?.nodeId) return;
      lastMsgCount = msgs.length;

      const container = document.getElementById('chatMessages');
      if (msgs.length === 0) {
        container.innerHTML = `<div class="empty-state" style="flex:1">
          <div class="empty-icon">ğŸ”</div>
          <div class="empty-sub">Les messages sont chiffrÃ©s.<br>Personne d'autre ne peut les lire.</div>
        </div>`;
        return;
      }

      container.innerHTML = msgs.map(m => {
        const isMe = m.from === 'me';
        const time = new Date(m.ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        return `<div class="msg-bubble ${isMe ? 'me' : 'them'}">
          <div class="bubble">${escapeHtml(m.text)}</div>
          <div class="bubble-meta">
            ${isMe ? 'Vous' : m.fromName} Â· ${time}
            <span class="encrypted-badge">ğŸ” E2E</span>
          </div>
        </div>`;
      }).join('');

      container.scrollTop = container.scrollHeight;
    } catch (e) {}
  }

  async function sendMessage() {
    if (!selectedPeer) return;
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';

    try {
      await fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ targetNodeId: selectedPeer.nodeId, message: text })
      });
      await loadMessages(selectedPeer.nodeId);
    } catch (e) {
      toast('Envoi Ã©chouÃ©', 'error');
    }
  }

  // â”€â”€ Fichiers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fileIcon(name) {
    const ext = name.split('.').pop().toLowerCase();
    const icons = { pdf: 'ğŸ“„', jpg: 'ğŸ–¼ï¸', jpeg: 'ğŸ–¼ï¸', png: 'ğŸ–¼ï¸', mp4: 'ğŸ¬', mp3: 'ğŸµ', zip: 'ğŸ—œï¸', txt: 'ğŸ“', doc: 'ğŸ“', docx: 'ğŸ“' };
    return icons[ext] || 'ğŸ“';
  }

  function formatSize(bytes) {
    if (bytes > 1024*1024*1024) return (bytes/1024/1024/1024).toFixed(1) + ' Go';
    if (bytes > 1024*1024) return (bytes/1024/1024).toFixed(1) + ' Mo';
    if (bytes > 1024) return (bytes/1024).toFixed(0) + ' Ko';
    return bytes + ' o';
  }

  async function refreshFiles() {
    try {
      const res = await fetch('/api/files');
      const data = await res.json();

      const localGrid = document.getElementById('localFilesGrid');
      const networkGrid = document.getElementById('networkFilesGrid');

      if (data.local.length === 0) {
        localGrid.innerHTML = `<div class="no-peers-msg" style="grid-column:1/-1">Vous n'avez pas encore partagÃ© de fichier</div>`;
      } else {
        localGrid.innerHTML = data.local.map(f => `
          <div class="file-card">
            <span class="badge-local">PartagÃ©</span>
            <div class="file-card-icon">${fileIcon(f.file_name)}</div>
            <div class="file-card-name">${f.file_name}</div>
            <div class="file-card-meta">${formatSize(f.total_size)} Â· ${f.total_chunks} blocs</div>
          </div>`).join('');
      }

      if (data.network.length === 0) {
        networkGrid.innerHTML = `<div class="no-peers-msg" style="grid-column:1/-1">Aucun fichier partagÃ© sur le rÃ©seau</div>`;
      } else {
        networkGrid.innerHTML = data.network.map(f => `
          <div class="file-card" onclick="promptDownload('${f.fileId}', '${escapeHtml(f.file_name)}', '${formatSize(f.total_size)}', '${escapeHtml(f.ownerName)}')">
            <span class="badge-network">RÃ©seau</span>
            <div class="file-card-icon">${fileIcon(f.file_name)}</div>
            <div class="file-card-name">${f.file_name}</div>
            <div class="file-card-meta">${formatSize(f.total_size)}</div>
            <div class="file-card-owner">PartagÃ© par ${f.ownerName}</div>
          </div>`).join('');
      }
    } catch (e) {}
  }

  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('shareZone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) shareFile(file.path || file.name);
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) shareFile(file.path || file.name);
  }

  async function shareFile(filePath) {
    toast('PrÃ©paration du fichier...', 'info');
    try {
      const res = await fetch('/api/files/share', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filePath })
      });
      const data = await res.json();
      if (data.success) {
        toast(`âœ… "${data.file.name}" partagÃ© sur le rÃ©seau`, 'success');
        refreshFiles();
      } else {
        toast('Erreur : ' + data.error, 'error');
      }
    } catch (e) {
      toast('Erreur lors du partage', 'error');
    }
  }

  function promptDownload(fileId, name, size, ownerName) {
    pendingDownload = { fileId, name };
    document.getElementById('downloadModalDesc').textContent =
      `"${name}" (${size}) â€” partagÃ© par ${ownerName}`;
    document.getElementById('downloadModal').classList.add('visible');
  }

  function closeModal() {
    document.getElementById('downloadModal').classList.remove('visible');
    pendingDownload = null;
  }

  async function confirmDownload() {
    if (!pendingDownload) return;
    closeModal();

    const { fileId, name } = pendingDownload;
    const progressEl = document.getElementById('downloadProgress');
    const fill = document.getElementById('progressFill');
    const label = document.getElementById('progressLabel');
    document.getElementById('downloadFilename').textContent = name;

    progressEl.classList.add('visible');
    fill.style.width = '0%';
    label.textContent = 'RÃ©cupÃ©ration des donnÃ©es...';

    let prog = 0;
    const interval = setInterval(() => {
      prog = Math.min(prog + Math.random() * 4, 88);
      fill.style.width = prog + '%';
    }, 400);

    try {
      const res = await fetch('/api/files/download', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileId })
      });
      const data = await res.json();
      clearInterval(interval);

      if (data.success) {
        fill.style.width = '100%';
        label.textContent = `âœ… TÃ©lÃ©chargÃ© dans downloads/`;
        toast(`"${name}" tÃ©lÃ©chargÃ© !`, 'success');
        setTimeout(() => progressEl.classList.remove('visible'), 4000);
        refreshFiles();
      } else {
        fill.style.width = '0%';
        label.textContent = 'âŒ ' + data.error;
        toast('Ã‰chec du tÃ©lÃ©chargement', 'error');
      }
    } catch (e) {
      clearInterval(interval);
      toast('Erreur rÃ©seau', 'error');
    }
  }

  // â”€â”€ IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function askAI() {
    const input = document.getElementById('aiInput');
    const query = input.value.trim();
    if (!query) return;
    input.value = '';

    const container = document.getElementById('aiMessages');

    // Question utilisateur
    container.insertAdjacentHTML('beforeend', `
      <div class="msg-bubble me">
        <div class="bubble">${escapeHtml(query)}</div>
        <div class="bubble-meta">Vous Â· maintenant</div>
      </div>`);

    // Indicateur chargement
    const loadId = 'load-' + Date.now();
    container.insertAdjacentHTML('beforeend', `
      <div class="msg-bubble them" id="${loadId}">
        <div class="bubble">â³ RÃ©flexion...</div>
      </div>`);
    container.scrollTop = container.scrollHeight;

    try {
      const res = await fetch('/api/ai/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await res.json();
      document.getElementById(loadId)?.remove();

      container.insertAdjacentHTML('beforeend', `
        <div class="msg-bubble them">
          <div class="bubble">${escapeHtml(data.text || ('âš ï¸ ' + (data.error || 'Erreur')))}</div>
          <div class="bubble-meta">Assistant Â· maintenant</div>
        </div>`);
      container.scrollTop = container.scrollHeight;
    } catch (e) {
      document.getElementById(loadId)?.remove();
      toast('IA inaccessible', 'error');
    }
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startPolling() {
    refreshNetwork();
    setInterval(refreshNetwork, 3000);
    setInterval(() => {
      if (selectedPeer) loadMessages(selectedPeer.nodeId);
    }, 2000);
  }

  // â”€â”€ VÃ©rification au chargement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.addEventListener('load', async () => {
    try {
      const res = await fetch('/api/auth/check');
      const data = await res.json();
      if (data.registered) {
        // Afficher le tab login directement
        switchAuthTab('login');
        document.querySelector('.auth-tab').textContent = `Bonjour, ${data.name} ğŸ‘‹`;
      }
    } catch (e) {}
  });
</script>
</body>
</html>