<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archipel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0e1117;
      --surface: #161b24;
      --surface2: #1c2333;
      --border: #252d3d;
      --blue: #4f8ef7;
      --blue-dim: rgba(79, 142, 247, 0.12);
      --green: #3dd68c;
      --green-dim: rgba(61, 214, 140, 0.10);
      --red: #f75555;
      --purple: #a855f7;
      --purple-dim: rgba(168, 85, 247, 0.12);
      --text: #e2e8f4;
      --text-2: #7a8aa0;
      --text-3: #3d4d63;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Sora', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }

    .page {
      display: none;
      height: 100vh;
    }

    .page.active {
      display: flex;
    }

    /* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
    #page-onboarding {
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at 50% 0%, rgba(79, 142, 247, 0.08) 0%, transparent 70%);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px;
      width: 440px;
      box-shadow: var(--shadow);
    }

    .brand {
      text-align: center;
      margin-bottom: 36px;
    }

    .brand-logo {
      width: 56px;
      height: 56px;
      background: var(--blue-dim);
      border: 1.5px solid var(--blue);
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      margin-bottom: 16px;
    }

    .brand h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .brand p {
      color: var(--text-2);
      font-size: 13px;
    }

    .auth-tabs {
      display: flex;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-bottom: 28px;
    }

    .auth-tab {
      flex: 1;
      padding: 9px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-2);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--surface2);
      color: var(--text);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-2);
      margin-bottom: 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 11px 14px;
      color: var(--text);
      font-family: 'Sora', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(79, 142, 247, 0.12);
    }

    .form-input::placeholder {
      color: var(--text-3);
    }

    .btn-main {
      width: 100%;
      padding: 13px;
      background: var(--blue);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-family: 'Sora', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-top: 8px;
    }

    .btn-main:hover {
      opacity: 0.88;
    }

    .btn-main:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-msg {
      color: var(--red);
      font-size: 12px;
      margin-top: 12px;
      text-align: center;
      min-height: 18px;
    }

    /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
    #page-app {
      flex-direction: row;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 268px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      height: 100vh;
    }

    .sb-head {
      padding: 18px 16px 14px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .av-me {
      background: var(--blue-dim);
      color: var(--blue);
      border: 1.5px solid rgba(79, 142, 247, 0.4);
    }

    .av-peer {
      background: var(--green-dim);
      color: var(--green);
      border: 1.5px solid rgba(61, 214, 140, 0.4);
    }

    .av-offline {
      background: rgba(122, 138, 160, 0.08);
      color: var(--text-3);
      border: 1.5px solid var(--border);
    }

    .av-ai {
      background: var(--purple-dim);
      color: var(--purple);
      border: 1.5px solid rgba(168, 85, 247, 0.4);
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-status {
      font-size: 11px;
      color: var(--text-2);
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 2px;
    }

    .dot-green {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 5px var(--green);
    }

    .net-badge {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 7px 11px;
      font-size: 12px;
      color: var(--text-2);
    }

    .net-badge strong {
      color: var(--green);
    }

    .sb-peers {
      flex: 1;
      overflow-y: auto;
      padding: 10px 8px;
    }

    .sec-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-3);
      padding: 6px 8px;
    }

    .peer-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background 0.15s;
    }

    .peer-row:hover {
      background: var(--surface2);
    }

    .peer-row.active {
      background: var(--blue-dim);
    }

    .peer-name {
      font-size: 13px;
      font-weight: 500;
    }

    .peer-sub {
      font-size: 11px;
      color: var(--text-2);
      margin-top: 1px;
    }

    .no-peers {
      padding: 24px 8px;
      text-align: center;
      color: var(--text-3);
      font-size: 12px;
      line-height: 2;
    }

    .sb-nav {
      display: flex;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .nav-btn {
      flex: 1;
      padding: 13px 6px;
      background: transparent;
      border: none;
      border-top: 2px solid transparent;
      color: var(--text-2);
      font-family: 'Sora', sans-serif;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      color: var(--text);
      background: var(--surface2);
    }

    .nav-btn.active {
      color: var(--blue);
      border-top-color: var(--blue);
      background: var(--blue-dim);
    }

    .nav-icon {
      font-size: 17px;
    }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      min-width: 0;
    }

    .view {
      display: none;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .view.active {
      display: flex;
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-2);
      text-align: center;
      padding: 40px;
    }

    .empty-icon {
      font-size: 52px;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .empty-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .empty-sub {
      font-size: 13px;
      line-height: 1.9;
    }

    /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
    .chat-head {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .chat-head h2 {
      font-size: 15px;
      font-weight: 600;
    }

    .chat-head p {
      font-size: 11px;
      color: var(--text-2);
      margin-top: 2px;
    }

    .chat-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 18px 20px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    /* Bulles */
    .bbl {
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }

    .bbl.me {
      align-self: flex-end;
      align-items: flex-end;
    }

    .bbl.them {
      align-self: flex-start;
      align-items: flex-start;
    }

    .bbl.ai {
      align-self: flex-start;
      align-items: flex-start;
      max-width: 85%;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.55;
      word-break: break-word;
    }

    .bbl.me .bubble {
      background: var(--blue);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bbl.them .bubble {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .bbl.ai .bubble {
      background: var(--purple-dim);
      border: 1px solid rgba(168, 85, 247, 0.25);
      border-bottom-left-radius: 4px;
    }

    .bbl-meta {
      font-size: 10px;
      color: var(--text-3);
      margin-top: 4px;
      padding: 0 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .badge-e2e {
      font-size: 9px;
      background: var(--green-dim);
      color: var(--green);
      padding: 1px 6px;
      border-radius: 20px;
      border: 1px solid rgba(61, 214, 140, 0.2);
    }

    .badge-ai {
      font-size: 9px;
      background: var(--purple-dim);
      color: var(--purple);
      padding: 1px 6px;
      border-radius: 20px;
      border: 1px solid rgba(168, 85, 247, 0.2);
    }

    /* Bulle fichier */
    .file-bbl {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 14px;
      min-width: 210px;
    }

    .bbl.me .file-bbl {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .bbl.them .file-bbl {
      background: var(--surface2);
      border: 1px solid var(--border);
    }

    .fi-icon {
      font-size: 26px;
      flex-shrink: 0;
    }

    .fi-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .fi-meta {
      font-size: 11px;
      opacity: 0.65;
      margin-top: 2px;
    }

    .fi-dl {
      font-size: 11px;
      font-weight: 600;
      color: var(--blue);
      cursor: pointer;
      background: var(--blue-dim);
      padding: 3px 10px;
      border-radius: 20px;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .fi-dl:hover {
      background: var(--blue);
      color: white;
    }

    /* Progression inline */
    .dl-card {
      min-width: 220px;
      padding: 10px 14px;
      border-radius: 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
    }

    .dl-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .dl-track {
      height: 4px;
      background: var(--bg);
      border-radius: 2px;
      overflow: hidden;
    }

    .dl-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--blue), var(--green));
      transition: width 0.4s;
      width: 0%;
    }

    .dl-lbl {
      font-size: 10px;
      color: var(--text-2);
      margin-top: 5px;
    }

    /* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
    .chat-bar {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .gemini-hint {
      display: none;
      margin-bottom: 8px;
      padding: 7px 12px;
      background: var(--purple-dim);
      border: 1px solid rgba(168, 85, 247, 0.3);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--purple);
      align-items: center;
      gap: 8px;
    }

    .gemini-hint.on {
      display: flex;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-attach {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-2);
      font-size: 17px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .btn-attach:hover {
      background: var(--surface2);
      color: var(--text);
      border-color: var(--blue);
    }

    .chat-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 10px 16px;
      color: var(--text);
      font-family: 'Sora', sans-serif;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .chat-input:focus {
      border-color: var(--blue);
    }

    .chat-input.gem-on {
      border-color: var(--purple);
      box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .chat-input::placeholder {
      color: var(--text-3);
    }

    .btn-send {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--blue);
      border: none;
      color: white;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s, opacity 0.2s;
    }

    .btn-send:hover {
      opacity: 0.85;
    }

    .btn-send.gem {
      background: var(--purple);
    }

    .bar-hint {
      font-size: 10px;
      color: var(--text-3);
      margin-top: 6px;
      padding: 0 4px;
    }

    #fileInputHidden {
      display: none;
    }

    /* ‚îÄ‚îÄ FILES VIEW ‚îÄ‚îÄ */
    .files-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .view-title {
      font-size: 19px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .view-subtitle {
      color: var(--text-2);
      font-size: 13px;
      margin-bottom: 24px;
    }

    .sec-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      color: var(--text-3);
      margin-bottom: 12px;
    }

    .files-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 12px;
      margin-bottom: 28px;
    }

    .fcard {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      position: relative;
    }

    .fcard.click {
      cursor: pointer;
      transition: all 0.2s;
    }

    .fcard.click:hover {
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(79, 142, 247, 0.07);
    }

    .fcard-icon {
      font-size: 26px;
      margin-bottom: 10px;
    }

    .fcard-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .fcard-meta {
      font-size: 11px;
      color: var(--text-2);
    }

    .fcard-owner {
      font-size: 11px;
      color: var(--blue);
      margin-top: 6px;
    }

    .fbadge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 9px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
    }

    .fbadge-local {
      background: var(--green-dim);
      color: var(--green);
    }

    .fbadge-net {
      background: var(--blue-dim);
      color: var(--blue);
    }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .overlay.on {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 380px;
      box-shadow: var(--shadow);
    }

    .modal h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .modal p {
      color: var(--text-2);
      font-size: 13px;
      margin-bottom: 22px;
      line-height: 1.6;
    }

    .modal-btns {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-cancel {
      padding: 10px 20px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: 'Sora', sans-serif;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-confirm {
      padding: 10px 20px;
      background: var(--blue);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-family: 'Sora', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toasts {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 999;
    }

    .toast {
      padding: 11px 16px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      animation: tIn 0.25s ease;
      box-shadow: var(--shadow);
    }

    .t-ok {
      background: rgba(61, 214, 140, 0.12);
      color: var(--green);
      border: 1px solid rgba(61, 214, 140, 0.25);
    }

    .t-err {
      background: rgba(247, 85, 85, 0.12);
      color: var(--red);
      border: 1px solid rgba(247, 85, 85, 0.25);
    }

    .t-inf {
      background: var(--blue-dim);
      color: var(--blue);
      border: 1px solid rgba(79, 142, 247, 0.25);
    }

    @keyframes tIn {
      from {
        transform: translateY(16px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }
  </style>
</head>

<body>

  <!-- ONBOARDING -->
  <div class="page active" id="page-onboarding">
    <div class="card">
      <div class="brand">
        <div class="brand-logo">üèùÔ∏è</div>
        <h1>Archipel</h1>
        <p>R√©seau priv√© ¬∑ Chiffr√© ¬∑ Sans serveur central</p>
      </div>
      <div class="auth-tabs">
        <div class="auth-tab active" id="tab-reg" onclick="switchTab('reg')">Cr√©er un compte</div>
        <div class="auth-tab" id="tab-log" onclick="switchTab('log')">Se connecter</div>
      </div>
      <div id="form-reg">
        <div class="form-row">
          <div class="form-group"><label class="form-label">Pr√©nom</label><input class="form-input" id="r-fn"
              type="text" placeholder="Alice"></div>
          <div class="form-group"><label class="form-label">Nom</label><input class="form-input" id="r-ln" type="text"
              placeholder="Dupont"></div>
        </div>
        <div class="form-group"><label class="form-label">Mot de passe</label><input class="form-input" id="r-pw"
            type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')register()"></div>
        <button class="btn-main" id="btn-reg" onclick="register()">Rejoindre le r√©seau</button>
        <div class="error-msg" id="r-err"></div>
      </div>
      <div id="form-log" style="display:none">
        <div style="font-size:13px;color:var(--text-2);margin-bottom:16px" id="log-hint"></div>
        <div class="form-group"><label class="form-label">Mot de passe</label><input class="form-input" id="l-pw"
            type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')login()"></div>
        <button class="btn-main" onclick="login()">Se connecter</button>
        <div class="error-msg" id="l-err"></div>
      </div>
    </div>
  </div>

  <!-- APPLICATION -->
  <div class="page" id="page-app">

    <div class="sidebar">
      <div class="sb-head">
        <div class="user-card">
          <div class="avatar av-me" id="myAv">?</div>
          <div>
            <div class="user-name" id="myName">‚Äî</div>
            <div class="user-status"><span class="dot-green"></span>Connect√©</div>
          </div>
        </div>
        <div class="net-badge"><span>üåê R√©seau local</span><strong id="peerCnt">0 pair</strong></div>
      </div>
      <div class="sb-peers">
        <div class="sec-label">Personnes en ligne</div>
        <div id="peerList">
          <div class="no-peers">üîç Recherche en cours...</div>
        </div>
      </div>
      <div class="sb-nav">
        <button class="nav-btn active" id="nav-msg" onclick="setNav('msg')"><span
            class="nav-icon">üí¨</span>Messages</button>
        <button class="nav-btn" id="nav-fil" onclick="setNav('fil')"><span class="nav-icon">üìÅ</span>Fichiers</button>
      </div>
    </div>

    <div class="main">

      <!-- Accueil -->
      <div class="view active" id="v-welcome">
        <div class="empty-state">
          <div class="empty-icon">üí¨</div>
          <div class="empty-title">Bienvenue sur Archipel</div>
          <div class="empty-sub">
            Cliquez sur une personne pour discuter<br>
            Tapez <strong style="color:var(--purple)">@gemini</strong> pour appeler l'IA dans la conversation<br>
            Cliquez sur <strong>üìé</strong> pour envoyer un fichier
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div class="view" id="v-chat">
        <div class="chat-head">
          <div class="avatar av-peer" id="chatAv">?</div>
          <div>
            <h2 id="chatName">‚Äî</h2>
            <p>üîê Chiffrement E2E ¬∑ <span style="color:var(--purple)">@gemini</span> pour appeler l'IA</p>
          </div>
        </div>
        <div class="chat-msgs" id="chatMsgs"></div>
        <div class="chat-bar">
          <div class="gemini-hint" id="ghint">‚ú® <span>Entr√©e pour envoyer √† Gemini</span></div>
          <div class="input-row">
            <button class="btn-attach" onclick="document.getElementById('fileInput').click()"
              title="Envoyer un fichier">üìé</button>
            <input type="file" id="fileInput" onchange="onFileSelect(event)">
            <input class="chat-input" id="chatIn" type="text" placeholder="Message... ou @gemini votre question"
              oninput="onInput(this)" onkeydown="onKey(event)">
            <button class="btn-send" id="btnSend" onclick="send()">‚û§</button>
          </div>
          <div class="bar-hint">üìé envoyer un fichier ¬∑ @gemini appeler l'IA ¬∑ Entr√©e pour envoyer</div>
        </div>
      </div>

      <!-- Fichiers -->
      <div class="view" id="v-files">
        <div class="files-body">
          <div class="view-title">Fichiers partag√©s</div>
          <div class="view-subtitle">Tous les fichiers disponibles sur le r√©seau</div>
          <div class="sec-title">Disponibles sur le r√©seau</div>
          <div class="files-grid" id="netFiles">
            <div class="no-peers" style="grid-column:1/-1">Aucun fichier sur le r√©seau</div>
          </div>
          <div class="sec-title">Mes fichiers partag√©s</div>
          <div class="files-grid" id="myFiles">
            <div class="no-peers" style="grid-column:1/-1">Vous n'avez pas encore partag√© de fichier</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="dlOverlay">
    <div class="modal">
      <h3>T√©l√©charger ce fichier ?</h3>
      <p id="dlDesc"></p>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="closeDl()">Annuler</button>
        <button class="btn-confirm" onclick="doDl()">T√©l√©charger</button>
      </div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    let me = null, peer = null, peers = [], pendingDl = null, gemMode = false, nav = 'msg';

    // helpers
    function toast(m, t = 'inf') {
      const e = document.createElement('div');
      e.className = `toast t-${t}`; e.textContent = m;
      document.getElementById('toasts').appendChild(e);
      setTimeout(() => e.remove(), 4000);
    }
    function esc(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
    function fmt(b) { return b > 1e9 ? (b / 1e9).toFixed(1) + ' Go' : b > 1e6 ? (b / 1e6).toFixed(1) + ' Mo' : b > 1e3 ? (b / 1e3).toFixed(0) + ' Ko' : b + ' o'; }
    function ficon(n) { const e = (n || '').split('.').pop().toLowerCase(); return { pdf: 'üìÑ', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è', mp4: 'üé¨', mp3: 'üéµ', wav: 'üéµ', zip: 'üóúÔ∏è', rar: 'üóúÔ∏è', txt: 'üìù', doc: 'üìù', docx: 'üìù', xls: 'üìä', xlsx: 'üìä', ppt: 'üìë', pptx: 'üìë' }[e] || 'üìÅ'; }
    function hm(ts) { return new Date(ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); }
    function showView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id)?.classList.add('active'); }

    // auth
    function switchTab(t) {
      document.getElementById('tab-reg').classList.toggle('active', t === 'reg');
      document.getElementById('tab-log').classList.toggle('active', t === 'log');
      document.getElementById('form-reg').style.display = t === 'reg' ? 'block' : 'none';
      document.getElementById('form-log').style.display = t === 'log' ? 'block' : 'none';
    }

    async function register() {
      const fn = document.getElementById('r-fn').value.trim(), ln = document.getElementById('r-ln').value.trim(), pw = document.getElementById('r-pw').value;
      const err = document.getElementById('r-err'), btn = document.getElementById('btn-reg');
      if (!fn || !ln || !pw) { err.textContent = 'Tous les champs sont requis'; return; }
      if (pw.length < 6) { err.textContent = 'Mot de passe trop court (6 car. min.)'; return; }
      btn.disabled = true; btn.textContent = 'Cr√©ation de votre identit√©...'; err.textContent = '';
      try {
        const d = await (await fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ firstName: fn, lastName: ln, password: pw }) })).json();
        if (d.success) { enterApp(d.displayName); } else { err.textContent = d.error || 'Erreur'; btn.disabled = false; btn.textContent = 'Rejoindre le r√©seau'; }
      } catch (e) { err.textContent = 'Serveur inaccessible'; btn.disabled = false; btn.textContent = 'Rejoindre le r√©seau'; }
    }

    async function login() {
      const pw = document.getElementById('l-pw').value, err = document.getElementById('l-err');
      try {
        const d = await (await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pw }) })).json();
        if (d.success) { enterApp(d.displayName); } else { err.textContent = d.error || 'Mot de passe incorrect'; }
      } catch (e) { err.textContent = 'Serveur inaccessible'; }
    }

    function enterApp(name) {
      me = name;
      document.getElementById('page-onboarding').classList.remove('active');
      document.getElementById('page-app').classList.add('active');
      document.getElementById('myName').textContent = name;
      document.getElementById('myAv').textContent = name.charAt(0).toUpperCase();
      toast(`Bienvenue, ${name} üëã`, 'ok');
      showView('v-welcome');
      startPolling();
    }

    // nav
    function setNav(n) {
      nav = n;
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('nav-' + n).classList.add('active');
      if (n === 'msg') { showView(peer ? 'v-chat' : 'v-welcome'); }
      if (n === 'fil') { showView('v-files'); loadFiles(); }
    }

    // peers
    function selectPeer(p) {
      peer = p; nav = 'msg';
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('nav-msg').classList.add('active');
      document.querySelectorAll('.peer-row').forEach(r => r.classList.remove('active'));
      document.getElementById('pr-' + p.nodeId)?.classList.add('active');
      document.getElementById('chatName').textContent = p.displayName;
      document.getElementById('chatAv').textContent = p.displayName.charAt(0).toUpperCase();
      document.getElementById('chatAv').className = 'avatar ' + (p.online ? 'av-peer' : 'av-offline');
      showView('v-chat');
      loadMsgs(p.nodeId);
    }

    async function refreshPeers() {
      try {
        const d = await (await fetch('/api/network')).json();
        peers = d.peers;
        const c = peers.length;
        document.getElementById('peerCnt').textContent = c === 0 ? '0 pair' : `${c} pair${c > 1 ? 's' : ''}`;
        const el = document.getElementById('peerList');
        el.innerHTML = c === 0
          ? `<div class="no-peers">üîç Aucune personne trouv√©e</div>`
          : peers.map(p => `<div class="peer-row ${peer?.nodeId === p.nodeId ? 'active' : ''}" id="pr-${esc(p.nodeId)}" onclick='selectPeer(${JSON.stringify(p)})'>
          <div class="avatar ${p.online ? 'av-peer' : 'av-offline'}" style="width:34px;height:34px;font-size:13px">${p.displayName.charAt(0).toUpperCase()}</div>
          <div><div class="peer-name">${esc(p.displayName)}</div><div class="peer-sub">${p.online ? 'üü¢ En ligne' : '‚ö´ Hors ligne'}</div></div>
        </div>`).join('');
      } catch (e) { }
    }

    // messages
    async function loadMsgs(nid) {
      try {
        const msgs = await (await fetch(`/api/chat/${nid}`)).json();
        renderMsgs(msgs);
      } catch (e) { }
    }

    function renderMsgs(msgs) {
      const c = document.getElementById('chatMsgs');
      if (msgs.length === 0) {
        c.innerHTML = `<div class="empty-state" style="flex:1"><div class="empty-icon">üîê</div><div class="empty-sub">Messages chiffr√©s E2E.<br>Tapez <strong style="color:var(--purple)">@gemini</strong> pour appeler l'IA.</div></div>`;
        return;
      }
      c.innerHTML = msgs.map(m => {
        const isMe = m.from === 'me', isAI = m.fromName === 'Gemini';
        const cls = isAI ? 'ai' : (isMe ? 'me' : 'them');
        const who = isAI ? '‚ú® Gemini' : (isMe ? 'Vous' : esc(m.fromName));
        const badge = isAI ? '<span class="badge-ai">‚ú® IA</span>' : '<span class="badge-e2e">üîê E2E</span>';

        if (m.fileId) {
          const fi = { fileId: m.fileId, name: m.fileName, size: m.fileSize };
          return `<div class="bbl ${cls}">
        <div class="file-bbl">
          <div class="fi-icon">${ficon(fi.name)}</div>
          <div style="flex:1;min-width:0"><div class="fi-name">${esc(fi.name)}</div><div class="fi-meta">${fmt(fi.size)}</div></div>
          ${!isMe ? `<span class="fi-dl" onclick="askDl('${fi.fileId}','${esc(fi.name)}','${fmt(fi.size)}','${esc(m.fromName)}')">T√©l√©charger</span>` : ''}
        </div>
        <div class="bbl-meta">${who} ¬∑ ${hm(m.ts)} ${badge}</div>
      </div>`;
        }

        return `<div class="bbl ${cls}">
      <div class="bubble">${esc(m.text)}</div>
      <div class="bbl-meta">${who} ¬∑ ${hm(m.ts)} ${badge}</div>
    </div>`;
      }).join('');
      c.scrollTop = c.scrollHeight;
    }

    // input @gemini detection
    function onInput(inp) {
      const v = inp.value;
      const hint = document.getElementById('ghint'), btn = document.getElementById('btnSend');
      gemMode = v.toLowerCase().startsWith('@gemini') && v.length > 7;
      inp.classList.toggle('gem-on', gemMode);
      hint.classList.toggle('on', gemMode);
      btn.classList.toggle('gem', gemMode);
    }

    function onKey(e) { if (e.key === 'Enter') send(); }

    async function send() {
      if (!peer) return;
      const inp = document.getElementById('chatIn');
      const txt = inp.value.trim();
      if (!txt) return;
      inp.value = ''; onInput(inp);

      if (gemMode || txt.toLowerCase().startsWith('@gemini')) {
        // ‚îÄ‚îÄ @gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const query = txt.replace(/^@gemini\s*/i, '').trim();
        if (!query) return;
        addBubble('me', me, txt);
        const lid = 'gl-' + Date.now();
        addBubble('ai-load', '...', null, null, lid);
        try {
          const d = await (await fetch('/api/ai/ask', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) })).json();
          document.getElementById(lid)?.remove();
          addBubble('ai', 'Gemini', d.text || ('‚ö†Ô∏è ' + (d.error || 'Erreur')));
        } catch (e) { document.getElementById(lid)?.remove(); addBubble('ai', 'Gemini', '‚ö†Ô∏è Gemini inaccessible'); }
      } else {
        // ‚îÄ‚îÄ message normal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        try {
          await fetch('/api/chat/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ targetNodeId: peer.nodeId, message: txt }) });
          await loadMsgs(peer.nodeId);
        } catch (e) { toast('Envoi √©chou√©', 'err'); }
      }
    }

    function addBubble(type, name, text, fileInfo, loadId) {
      const c = document.getElementById('chatMsgs');
      // vider l'empty state si pr√©sent
      if (c.querySelector('.empty-state')) c.innerHTML = '';
      const isMe = type === 'me', isAI = type === 'ai';
      const cls = isAI ? 'ai' : (isMe ? 'me' : 'them');
      const who = isAI ? '‚ú® Gemini' : (isMe ? 'Vous' : esc(name));
      const badge = isAI ? '<span class="badge-ai">‚ú® IA</span>' : '<span class="badge-e2e">üîê E2E</span>';

      if (loadId) {
        c.insertAdjacentHTML('beforeend', `<div class="bbl ai" id="${loadId}"><div class="bubble">‚ú® Gemini r√©fl√©chit...</div></div>`);
      } else {
        c.insertAdjacentHTML('beforeend', `<div class="bbl ${cls}"><div class="bubble">${esc(text)}</div><div class="bbl-meta">${who} ¬∑ ${hm(Date.now())} ${badge}</div></div>`);
      }
      c.scrollTop = c.scrollHeight;
    }

    // envoi fichier
    function onFileSelect(e) {
      const f = e.target.files[0]; e.target.value = '';
      if (!f) return;
      if (!peer) { toast('S√©lectionnez un pair d\'abord', 'err'); return; }
      shareFile(f);  // on passe l'objet File directement
    }

    async function shareFile(file) {
      const fileName = file.name;
      const fileSize = file.size;
      const c = document.getElementById('chatMsgs');
      if (c.querySelector('.empty-state')) c.innerHTML = '';
      const lid = 'fs-' + Date.now();
      c.insertAdjacentHTML('beforeend', `<div class="bbl me" id="${lid}"><div class="bubble">üì§ Partage de ${esc(fileName)}...</div></div>`);
      c.scrollTop = c.scrollHeight;
      toast('Pr√©paration du fichier...', 'inf');

      try {
        // FormData : le fichier est stream√© directement, fonctionne avec n'importe quel fichier
        const formData = new FormData();
        formData.append('file', file, fileName);
        const d = await (await fetch('/api/files/share-upload', { method: 'POST', body: formData })).json();
        document.getElementById(lid)?.remove();
        if (d.success) {
          c.insertAdjacentHTML('beforeend', `
        <div class="bbl me">
          <div class="file-bbl">
            <div class="fi-icon">${ficon(d.file.name)}</div>
            <div style="flex:1;min-width:0"><div class="fi-name">${esc(d.file.name)}</div><div class="fi-meta">${fmt(d.file.size)} ¬∑ Partag√©</div></div>
          </div>
          <div class="bbl-meta">Vous ¬∑ ${hm(Date.now())} <span class="badge-e2e">üîê E2E</span></div>
        </div>`);
          c.scrollTop = c.scrollHeight;
          toast(`"${d.file.name}" partag√©`, 'ok');

          // Notifier le pair que le fichier est disponible
          if (peer) {
            try {
              await fetch('/api/chat/send-file', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetNodeId: peer.nodeId, fileId: d.file.fileId, fileName: d.file.name, fileSize: d.file.size })
              });
            } catch (err) { toast('Envoi de notification √©chou√©', 'err'); }
          }
        } else { toast('Erreur : ' + d.error, 'err'); }
      } catch (e) { document.getElementById(lid)?.remove(); toast('Erreur d\'envoi : ' + e.message, 'err'); }
    }

    // t√©l√©chargement fichier
    function askDl(fileId, name, size, ownerName) {
      pendingDl = { fileId, name };
      document.getElementById('dlDesc').textContent = `"${name}" (${size}) ‚Äî partag√© par ${ownerName}`;
      document.getElementById('dlOverlay').classList.add('on');
    }
    function closeDl() { document.getElementById('dlOverlay').classList.remove('on'); pendingDl = null; }

    async function doDl() {
      if (!pendingDl) return;
      closeDl();
      const { fileId, name } = pendingDl;
      const c = document.getElementById('chatMsgs');
      const did = 'dl-' + Date.now();
      c.insertAdjacentHTML('beforeend', `
    <div class="bbl them" id="${did}">
      <div class="dl-card">
        <div class="dl-name">üì• ${esc(name)}</div>
        <div class="dl-track"><div class="dl-fill" id="dlf-${did}"></div></div>
        <div class="dl-lbl" id="dll-${did}">T√©l√©chargement en cours...</div>
      </div>
    </div>`);
      c.scrollTop = c.scrollHeight;

      let p = 0;
      const iv = setInterval(() => { p = Math.min(p + Math.random() * 5, 88); const e = document.getElementById('dlf-' + did); if (e) e.style.width = p + '%'; }, 400);

      try {
        const d = await (await fetch('/api/files/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ fileId }) })).json();
        clearInterval(iv);
        const fe = document.getElementById('dlf-' + did), le = document.getElementById('dll-' + did);
        if (d.success) {
          if (fe) fe.style.width = '100%';
          if (le) le.textContent = '‚úÖ Assembl√© ‚Äî t√©l√©chargement...';

          // D√©clencher le vrai t√©l√©chargement dans le navigateur
          // Utiliser window.location est plus robuste que fetch+blob pour les gros fichiers
          window.location.assign(`/api/files/serve/${d.fileId}`);

          if (le) le.textContent = '‚úÖ T√©l√©charg√© !';
          toast(`"${name}" t√©l√©charg√© !`, 'ok');
        } else {
          if (le) le.textContent = '‚ùå ' + d.error;
          toast('T√©l√©chargement √©chou√©', 'err');
        }
      } catch (e) { clearInterval(iv); toast('Erreur r√©seau', 'err'); }
    }

    // fichiers vue
    async function loadFiles() {
      try {
        const d = await (await fetch('/api/files')).json();
        document.getElementById('myFiles').innerHTML = d.local.length === 0
          ? `<div class="no-peers" style="grid-column:1/-1">Aucun fichier partag√©</div>`
          : d.local.map(f => `<div class="fcard"><span class="fbadge fbadge-local">Partag√©</span><div class="fcard-icon">${ficon(f.file_name)}</div><div class="fcard-name">${esc(f.file_name)}</div><div class="fcard-meta">${fmt(f.total_size)} ¬∑ ${f.total_chunks} blocs</div></div>`).join('');

        document.getElementById('netFiles').innerHTML = d.network.length === 0
          ? `<div class="no-peers" style="grid-column:1/-1">Aucun fichier disponible</div>`
          : d.network.map(f => `<div class="fcard click" onclick="askDl('${esc(f.fileId)}','${esc(f.file_name)}','${fmt(f.total_size)}','${esc(f.ownerName)}')"><span class="fbadge fbadge-net">R√©seau</span><div class="fcard-icon">${ficon(f.file_name)}</div><div class="fcard-name">${esc(f.file_name)}</div><div class="fcard-meta">${fmt(f.total_size)}</div><div class="fcard-owner">Par ${esc(f.ownerName)}</div></div>`).join('');
      } catch (e) { }
    }

    // polling
    function startPolling() {
      refreshPeers();
      setInterval(refreshPeers, 3000);
      setInterval(() => { if (peer && nav === 'msg' && !gemMode) loadMsgs(peer.nodeId); }, 2000);
    }

    // check au load
    window.addEventListener('load', async () => {
      try {
        const d = await (await fetch('/api/auth/check')).json();
        if (d.registered) { switchTab('log'); document.getElementById('log-hint').textContent = `Bonjour ${d.name} üëã`; }
      } catch (e) { }
    });
  </script>
</body>

</html>