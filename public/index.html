<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Archipel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #0e1117;
  --surface:   #161b24;
  --surface2:  #1c2333;
  --border:    #252d3d;
  --blue:      #4f8ef7;
  --blue-dim:  rgba(79,142,247,0.12);
  --green:     #3dd68c;
  --green-dim: rgba(61,214,140,0.10);
  --red:       #f75555;
  --purple:    #a855f7;
  --text:      #e2e8f4;
  --text-2:    #7a8aa0;
  --text-3:    #3d4d63;
  --radius:    12px;
  --radius-sm: 8px;
  --shadow:    0 8px 32px rgba(0,0,0,0.4);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Sora', sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  line-height: 1.5;
}

/* â•â• PAGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page { display: none; height: 100vh; }
.page.active { display: flex; }

/* â•â• ONBOARDING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#page-onboarding {
  align-items: center;
  justify-content: center;
  background: radial-gradient(ellipse at 50% 0%, rgba(79,142,247,0.08) 0%, transparent 70%);
}

.onboarding-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 48px;
  width: 440px;
  box-shadow: var(--shadow);
}

.brand { text-align: center; margin-bottom: 36px; }

.brand-logo {
  width: 56px; height: 56px;
  background: var(--blue-dim);
  border: 1.5px solid var(--blue);
  border-radius: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  margin-bottom: 16px;
}

.brand h1 { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px; }
.brand p  { color: var(--text-2); font-size: 13px; font-weight: 300; }

.auth-tabs {
  display: flex;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 4px;
  margin-bottom: 28px;
}

.auth-tab {
  flex: 1; padding: 9px;
  text-align: center;
  font-size: 13px; font-weight: 500;
  color: var(--text-2);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s;
}

.auth-tab.active {
  background: var(--surface2);
  color: var(--text);
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.form-group { margin-bottom: 16px; }

.form-label {
  display: block;
  font-size: 12px; font-weight: 500;
  color: var(--text-2);
  margin-bottom: 8px;
  letter-spacing: 0.3px;
}

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.form-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 11px 14px;
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.12);
}

.form-input::placeholder { color: var(--text-3); }

.btn-main {
  width: 100%;
  padding: 13px;
  background: var(--blue);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'Sora', sans-serif;
  font-size: 14px; font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.1s;
  margin-top: 8px;
}

.btn-main:hover   { opacity: 0.9; }
.btn-main:active  { transform: scale(0.99); }
.btn-main:disabled { opacity: 0.5; cursor: not-allowed; }

.error-msg {
  color: var(--red);
  font-size: 12px;
  margin-top: 12px;
  text-align: center;
  min-height: 18px;
}

/* â•â• APP LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#page-app { flex-direction: row; overflow: hidden; }

/* â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width: 270px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  height: 100vh;
}

.sidebar-header {
  padding: 18px 16px 14px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.user-card { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }

.avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700;
  flex-shrink: 0;
}

.avatar-me     { background: var(--blue-dim);  color: var(--blue);   border: 1.5px solid rgba(79,142,247,0.4); }
.avatar-peer   { background: var(--green-dim); color: var(--green);  border: 1.5px solid rgba(61,214,140,0.4); }
.avatar-offline{ background: rgba(122,138,160,0.08); color: var(--text-3); border: 1.5px solid var(--border); }

.user-info { flex: 1; min-width: 0; }
.user-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-status { font-size: 11px; color: var(--text-2); display: flex; align-items: center; gap: 5px; margin-top: 2px; }

.dot-green { width: 6px; height: 6px; border-radius: 50%; background: var(--green); box-shadow: 0 0 5px var(--green); }

.network-badge {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 7px 11px;
  font-size: 12px; color: var(--text-2);
}

.network-badge strong { color: var(--green); }

.sidebar-peers {
  flex: 1;
  overflow-y: auto;
  padding: 10px 8px;
}

.section-label {
  font-size: 10px; font-weight: 600;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-3);
  padding: 6px 8px 6px;
}

.peer-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.15s;
}

.peer-row:hover  { background: var(--surface2); }
.peer-row.active { background: var(--blue-dim); }

.peer-row .peer-info { flex: 1; min-width: 0; }
.peer-name { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.peer-sub  { font-size: 11px; color: var(--text-2); margin-top: 1px; }

.no-peers-msg {
  padding: 24px 8px;
  text-align: center;
  color: var(--text-3);
  font-size: 12px;
  line-height: 2;
}

/* Sidebar bottom nav */
.sidebar-nav {
  display: flex;
  border-top: 1px solid var(--border);
  flex-shrink: 0;
}

.nav-btn {
  flex: 1; padding: 14px 8px;
  background: transparent;
  border: none;
  color: var(--text-2);
  font-family: 'Sora', sans-serif;
  font-size: 11px;
  cursor: pointer;
  display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  transition: all 0.2s;
  border-top: 2px solid transparent;
}

.nav-btn:hover { color: var(--text); background: var(--surface2); }

.nav-btn.active {
  color: var(--blue);
  border-top-color: var(--blue);
  background: var(--blue-dim);
}

.nav-btn-icon { font-size: 18px; }

/* â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
  min-width: 0;
}

/* â•â• VIEWS â€” toutes cachÃ©es par dÃ©faut via JS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.view { display: none; flex-direction: column; height: 100%; overflow: hidden; }
.view.active { display: flex; }

/* â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  color: var(--text-2);
  text-align: center;
  padding: 40px;
}

.empty-icon  { font-size: 52px; margin-bottom: 16px; opacity: 0.4; }
.empty-title { font-size: 17px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.empty-sub   { font-size: 13px; line-height: 1.8; color: var(--text-2); }

/* â•â• CHAT VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-header {
  padding: 14px 22px;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  display: flex; align-items: center; gap: 12px;
  flex-shrink: 0;
}

.chat-header-info h2 { font-size: 15px; font-weight: 600; }
.chat-header-info p  { font-size: 12px; color: var(--text-2); margin-top: 2px; }

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px 22px;
  display: flex; flex-direction: column;
  gap: 10px;
}

.msg-bubble { display: flex; flex-direction: column; max-width: 65%; }
.msg-bubble.me   { align-self: flex-end; align-items: flex-end; }
.msg-bubble.them { align-self: flex-start; align-items: flex-start; }

.bubble {
  padding: 10px 15px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  word-break: break-word;
}

.msg-bubble.me .bubble {
  background: var(--blue);
  color: white;
  border-bottom-right-radius: 4px;
}

.msg-bubble.them .bubble {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.bubble-meta {
  font-size: 10px; color: var(--text-3);
  margin-top: 4px; padding: 0 4px;
  display: flex; align-items: center; gap: 5px;
}

.e2e-badge {
  font-size: 9px;
  background: var(--green-dim);
  color: var(--green);
  padding: 1px 6px;
  border-radius: 20px;
  border: 1px solid rgba(61,214,140,0.2);
}

.chat-input-bar {
  padding: 14px 18px;
  border-top: 1px solid var(--border);
  background: var(--surface);
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}

.chat-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 10px 18px;
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}

.chat-input:focus { border-color: var(--blue); }
.chat-input::placeholder { color: var(--text-3); }

.btn-send {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: var(--blue);
  border: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: opacity 0.2s;
}

.btn-send:hover { opacity: 0.85; }

/* â•â• FILES VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.files-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.view-title    { font-size: 19px; font-weight: 700; margin-bottom: 4px; }
.view-subtitle { color: var(--text-2); font-size: 13px; margin-bottom: 24px; }

.share-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 36px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 28px;
}

.share-zone:hover, .share-zone.drag-over {
  border-color: var(--blue);
  background: var(--blue-dim);
}

.share-zone-icon  { font-size: 32px; margin-bottom: 10px; }
.share-zone-title { font-weight: 600; margin-bottom: 4px; }
.share-zone-sub   { color: var(--text-2); font-size: 13px; }
#fileInputHidden  { display: none; }

.files-section-title {
  font-size: 11px; font-weight: 600;
  letter-spacing: 0.8px; text-transform: uppercase;
  color: var(--text-3);
  margin-bottom: 12px;
}

.files-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 28px;
}

.file-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}

.file-card:hover {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(79,142,247,0.07);
}

.file-card-icon { font-size: 26px; margin-bottom: 10px; }
.file-card-name { font-weight: 600; font-size: 13px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.file-card-meta { font-size: 11px; color: var(--text-2); }
.file-card-owner{ font-size: 11px; color: var(--blue); margin-top: 6px; }

.badge {
  position: absolute; top: 10px; right: 10px;
  font-size: 9px; font-weight: 600;
  padding: 2px 8px; border-radius: 20px;
}

.badge-local   { background: var(--green-dim); color: var(--green); }
.badge-network { background: var(--blue-dim);  color: var(--blue); }

/* Barre de progression */
.progress-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
}

.progress-title { font-weight: 600; font-size: 13px; margin-bottom: 10px; }
.progress-track { height: 5px; background: var(--bg); border-radius: 3px; overflow: hidden; }
.progress-fill  {
  height: 100%;
  background: linear-gradient(90deg, var(--blue), var(--green));
  border-radius: 3px;
  transition: width 0.4s;
  width: 0%;
}
.progress-label { font-size: 11px; color: var(--text-2); margin-top: 6px; }

/* â•â• AI VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* RÃ©utilise chat-messages, chat-input-bar */

/* â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 200;
  align-items: center; justify-content: center;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 28px;
  width: 380px;
  box-shadow: var(--shadow);
}

.modal h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
.modal p  { color: var(--text-2); font-size: 13px; margin-bottom: 22px; line-height: 1.6; }

.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

.btn-cancel {
  padding: 10px 20px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: 'Sora', sans-serif;
  font-size: 13px;
  cursor: pointer;
}

.btn-confirm {
  padding: 10px 20px;
  background: var(--blue);
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-family: 'Sora', sans-serif;
  font-size: 13px; font-weight: 600;
  cursor: pointer;
}

/* â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toasts {
  position: fixed; bottom: 20px; right: 20px;
  display: flex; flex-direction: column; gap: 8px;
  z-index: 999;
}

.toast {
  padding: 11px 16px;
  border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 500;
  animation: toastIn 0.25s ease;
  box-shadow: var(--shadow);
}

.toast-success { background: rgba(61,214,140,0.12);  color: var(--green);  border: 1px solid rgba(61,214,140,0.25); }
.toast-error   { background: rgba(247,85,85,0.12);   color: var(--red);    border: 1px solid rgba(247,85,85,0.25); }
.toast-info    { background: var(--blue-dim);         color: var(--blue);   border: 1px solid rgba(79,142,247,0.25); }

@keyframes toastIn {
  from { transform: translateY(16px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<!-- â•â• PAGE ONBOARDING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-onboarding">
  <div class="onboarding-card">
    <div class="brand">
      <div class="brand-logo">ğŸï¸</div>
      <h1>Archipel</h1>
      <p>RÃ©seau privÃ© Â· ChiffrÃ© Â· Sans serveur central</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" id="tab-register" onclick="switchAuthTab('register')">CrÃ©er un compte</div>
      <div class="auth-tab"        id="tab-login"    onclick="switchAuthTab('login')">Se connecter</div>
    </div>

    <!-- Inscription -->
    <div id="form-register">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">PrÃ©nom</label>
          <input class="form-input" id="reg-firstname" type="text" placeholder="Alice">
        </div>
        <div class="form-group">
          <label class="form-label">Nom</label>
          <input class="form-input" id="reg-lastname" type="text" placeholder="Dupont">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Mot de passe</label>
        <input class="form-input" id="reg-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          onkeydown="if(event.key==='Enter') register()">
      </div>
      <button class="btn-main" id="btn-register" onclick="register()">
        Rejoindre le rÃ©seau
      </button>
      <div class="error-msg" id="reg-error"></div>
    </div>

    <!-- Connexion -->
    <div id="form-login" style="display:none">
      <div class="form-group" style="margin-bottom:6px">
        <div style="font-size:13px;color:var(--text-2);margin-bottom:16px" id="login-name-hint"></div>
        <label class="form-label">Mot de passe</label>
        <input class="form-input" id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
          onkeydown="if(event.key==='Enter') login()">
      </div>
      <button class="btn-main" onclick="login()">Se connecter</button>
      <div class="error-msg" id="login-error"></div>
    </div>
  </div>
</div>

<!-- â•â• PAGE APPLICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-app">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="user-card">
        <div class="avatar avatar-me" id="myAvatar">?</div>
        <div class="user-info">
          <div class="user-name" id="myName">â€”</div>
          <div class="user-status"><span class="dot-green"></span> ConnectÃ©</div>
        </div>
      </div>
      <div class="network-badge">
        <span>ğŸŒ RÃ©seau local</span>
        <strong id="peerCountBadge">0 pair</strong>
      </div>
    </div>

    <div class="sidebar-peers">
      <div class="section-label">Personnes sur le rÃ©seau</div>
      <div id="peerListEl">
        <div class="no-peers-msg">ğŸ” Recherche en cours...</div>
      </div>
    </div>

    <div class="sidebar-nav">
      <button class="nav-btn active" id="nav-messages" onclick="setNav('messages')">
        <span class="nav-btn-icon">ğŸ’¬</span>Messages
      </button>
      <button class="nav-btn" id="nav-files" onclick="setNav('files')">
        <span class="nav-btn-icon">ğŸ“</span>Fichiers
      </button>
      <button class="nav-btn" id="nav-ai" onclick="setNav('ai')">
        <span class="nav-btn-icon">âœ¨</span>IA
      </button>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="main-content">

    <!-- Vue : Accueil messages -->
    <div class="view active" id="view-welcome">
      <div class="empty-state">
        <div class="empty-icon">ğŸ’¬</div>
        <div class="empty-title">Vos messages chiffrÃ©s</div>
        <div class="empty-sub">Cliquez sur une personne dans la liste<br>pour dÃ©marrer une conversation sÃ©curisÃ©e</div>
      </div>
    </div>

    <!-- Vue : Chat avec un pair -->
    <div class="view" id="view-chat">
      <div class="chat-header">
        <div class="avatar avatar-peer" id="chatAvatar">?</div>
        <div class="chat-header-info">
          <h2 id="chatPeerName">â€”</h2>
          <p>ğŸ” Chiffrement de bout en bout actif</p>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-bar">
        <input class="chat-input" id="chatInput"
          type="text" placeholder="Votre message..."
          onkeydown="if(event.key==='Enter') sendMessage()">
        <button class="btn-send" onclick="sendMessage()" title="Envoyer">â¤</button>
      </div>
    </div>

    <!-- Vue : Fichiers -->
    <div class="view" id="view-files">
      <div class="files-content">
        <div class="view-title">Partage de fichiers</div>
        <div class="view-subtitle">Partagez des fichiers avec les personnes sur le rÃ©seau</div>

        <div class="share-zone" id="shareZone"
          onclick="document.getElementById('fileInputHidden').click()"
          ondragover="event.preventDefault(); this.classList.add('drag-over')"
          ondragleave="this.classList.remove('drag-over')"
          ondrop="handleDrop(event)">
          <div class="share-zone-icon">ğŸ“¤</div>
          <div class="share-zone-title">DÃ©poser un fichier ici</div>
          <div class="share-zone-sub">ou cliquer pour sÃ©lectionner</div>
        </div>
        <input type="file" id="fileInputHidden" onchange="handleFileSelect(event)">

        <!-- Progression -->
        <div class="progress-card" id="progressCard" style="display:none">
          <div class="progress-title" id="progressTitle">TÃ©lÃ©chargement...</div>
          <div class="progress-track"><div class="progress-fill" id="progressFill"></div></div>
          <div class="progress-label" id="progressLabel">DÃ©marrage...</div>
        </div>

        <div class="files-section-title">Disponibles sur le rÃ©seau</div>
        <div class="files-grid" id="networkFiles">
          <div class="no-peers-msg" style="grid-column:1/-1">Aucun fichier partagÃ© sur le rÃ©seau</div>
        </div>

        <div class="files-section-title">Mes fichiers partagÃ©s</div>
        <div class="files-grid" id="localFiles">
          <div class="no-peers-msg" style="grid-column:1/-1">Vous n'avez pas encore partagÃ© de fichier</div>
        </div>
      </div>
    </div>

    <!-- Vue : IA -->
    <div class="view" id="view-ai">
      <div class="chat-header">
        <div class="avatar" style="background:rgba(168,85,247,0.1);color:var(--purple);border:1.5px solid rgba(168,85,247,0.35)">âœ¨</div>
        <div class="chat-header-info">
          <h2>Assistant IA</h2>
          <p>Posez n'importe quelle question</p>
        </div>
      </div>
      <div class="chat-messages" id="aiMessages">
        <div class="msg-bubble them">
          <div class="bubble">Bonjour ! Je suis votre assistant. Comment puis-je vous aider ?</div>
          <div class="bubble-meta">Assistant Â· maintenant</div>
        </div>
      </div>
      <div class="chat-input-bar">
        <input class="chat-input" id="aiInput"
          type="text" placeholder="Votre question..."
          onkeydown="if(event.key==='Enter') askAI()">
        <button class="btn-send" onclick="askAI()">â¤</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal tÃ©lÃ©chargement -->
<div class="modal-overlay" id="downloadModal">
  <div class="modal">
    <h3>TÃ©lÃ©charger ce fichier ?</h3>
    <p id="downloadModalDesc"></p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Annuler</button>
      <button class="btn-confirm" onclick="confirmDownload()">TÃ©lÃ©charger</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// â”€â”€ Ã‰tat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser  = null;
let selectedPeer = null;
let allPeers     = [];
let pendingDl    = null;
let lastMsgTs    = 0;
let currentNav   = 'messages';

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmt(bytes) {
  if (bytes > 1e9) return (bytes/1e9).toFixed(1)+' Go';
  if (bytes > 1e6) return (bytes/1e6).toFixed(1)+' Mo';
  if (bytes > 1e3) return (bytes/1e3).toFixed(0)+' Ko';
  return bytes+' o';
}

function fileIcon(name) {
  const ext = (name||'').split('.').pop().toLowerCase();
  return {pdf:'ğŸ“„',jpg:'ğŸ–¼ï¸',jpeg:'ğŸ–¼ï¸',png:'ğŸ–¼ï¸',gif:'ğŸ–¼ï¸',
          mp4:'ğŸ¬',mov:'ğŸ¬',avi:'ğŸ¬',mp3:'ğŸµ',wav:'ğŸµ',
          zip:'ğŸ—œï¸',rar:'ğŸ—œï¸',txt:'ğŸ“',doc:'ğŸ“',docx:'ğŸ“',
          xls:'ğŸ“Š',xlsx:'ğŸ“Š',ppt:'ğŸ“‘',pptx:'ğŸ“‘'}[ext] || 'ğŸ“';
}

function timeStr(ts) {
  return new Date(ts).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}

// â”€â”€ Navigation principale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById('view-' + id);
  if (el) el.classList.add('active');
}

function setNav(nav) {
  currentNav = nav;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('nav-' + nav).classList.add('active');

  if (nav === 'messages') {
    showView(selectedPeer ? 'chat' : 'welcome');
  } else if (nav === 'files') {
    showView('files');
    refreshFiles();
  } else if (nav === 'ai') {
    showView('ai');
  }
}

// â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchAuthTab(tab) {
  document.getElementById('tab-register').classList.toggle('active', tab === 'register');
  document.getElementById('tab-login').classList.toggle('active',    tab === 'login');
  document.getElementById('form-register').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('form-login').style.display    = tab === 'login'    ? 'block' : 'none';
}

async function register() {
  const firstName = document.getElementById('reg-firstname').value.trim();
  const lastName  = document.getElementById('reg-lastname').value.trim();
  const password  = document.getElementById('reg-password').value;
  const errEl     = document.getElementById('reg-error');
  const btn       = document.getElementById('btn-register');

  if (!firstName || !lastName || !password) {
    errEl.textContent = 'Tous les champs sont requis'; return;
  }
  if (password.length < 6) {
    errEl.textContent = 'Mot de passe trop court (6 caractÃ¨res min.)'; return;
  }

  btn.disabled = true;
  btn.textContent = 'CrÃ©ation de votre identitÃ©...';
  errEl.textContent = '';

  try {
    const res  = await fetch('/api/auth/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ firstName, lastName, password })
    });
    const data = await res.json();

    if (data.success) {
      enterApp(data.displayName);
    } else {
      errEl.textContent = data.error || 'Erreur';
      btn.disabled = false;
      btn.textContent = 'Rejoindre le rÃ©seau';
    }
  } catch (e) {
    errEl.textContent = 'Impossible de contacter le serveur';
    btn.disabled = false;
    btn.textContent = 'Rejoindre le rÃ©seau';
  }
}

async function login() {
  const password = document.getElementById('login-password').value;
  const errEl    = document.getElementById('login-error');

  try {
    const res  = await fetch('/api/auth/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password })
    });
    const data = await res.json();

    if (data.success) {
      enterApp(data.displayName);
    } else {
      errEl.textContent = data.error || 'Mot de passe incorrect';
    }
  } catch (e) {
    errEl.textContent = 'Impossible de contacter le serveur';
  }
}

function enterApp(displayName) {
  currentUser = displayName;
  document.getElementById('page-onboarding').classList.remove('active');
  document.getElementById('page-app').classList.add('active');
  document.getElementById('myName').textContent   = displayName;
  document.getElementById('myAvatar').textContent = displayName.charAt(0).toUpperCase();
  toast(`Bienvenue, ${displayName} ! ğŸ‘‹`, 'success');
  showView('welcome');
  startPolling();
}

// â”€â”€ SÃ©lection d'un pair â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectPeer(peer) {
  selectedPeer = peer;
  currentNav   = 'messages';

  // Mettre Ã  jour nav
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('nav-messages').classList.add('active');

  // Mettre en surbrillance dans sidebar
  document.querySelectorAll('.peer-row').forEach(r => r.classList.remove('active'));
  const row = document.getElementById('peer-row-' + peer.nodeId);
  if (row) row.classList.add('active');

  // Mettre Ã  jour l'en-tÃªte du chat
  document.getElementById('chatPeerName').textContent = peer.displayName;
  document.getElementById('chatAvatar').textContent   = peer.displayName.charAt(0).toUpperCase();
  document.getElementById('chatAvatar').className = 'avatar ' + (peer.online ? 'avatar-peer' : 'avatar-offline');

  // Afficher la vue chat
  showView('chat');

  // Charger les messages
  loadMessages(peer.nodeId);
}

// â”€â”€ RÃ©seau / pairs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshNetwork() {
  try {
    const res  = await fetch('/api/network');
    const data = await res.json();
    allPeers   = data.peers;

    const count = allPeers.length;
    document.getElementById('peerCountBadge').textContent =
      count === 0 ? '0 pair' : `${count} pair${count > 1 ? 's' : ''}`;

    const el = document.getElementById('peerListEl');
    if (count === 0) {
      el.innerHTML = `<div class="no-peers-msg">ğŸ” Aucune personne trouvÃ©e<br>sur le rÃ©seau pour l'instant</div>`;
    } else {
      el.innerHTML = allPeers.map(p => {
        const initial = (p.displayName || '?').charAt(0).toUpperCase();
        const isActive = selectedPeer?.nodeId === p.nodeId;
        return `
          <div class="peer-row ${isActive ? 'active' : ''}"
               id="peer-row-${escHtml(p.nodeId)}"
               onclick='selectPeer(${JSON.stringify(p)})'>
            <div class="avatar ${p.online ? 'avatar-peer' : 'avatar-offline'}"
                 style="width:34px;height:34px;font-size:13px">${initial}</div>
            <div class="peer-info">
              <div class="peer-name">${escHtml(p.displayName)}</div>
              <div class="peer-sub">${p.online ? 'ğŸŸ¢ En ligne' : 'âš« Hors ligne'}</div>
            </div>
          </div>`;
      }).join('');
    }
  } catch (e) {}
}

// â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMessages(nodeId) {
  try {
    const res  = await fetch(`/api/chat/${nodeId}`);
    const msgs = await res.json();
    const container = document.getElementById('chatMessages');

    if (msgs.length === 0) {
      container.innerHTML = `
        <div class="empty-state" style="flex:1">
          <div class="empty-icon">ğŸ”</div>
          <div class="empty-sub">Les messages sont chiffrÃ©s.<br>Personne d'autre ne peut les lire.</div>
        </div>`;
      return;
    }

    container.innerHTML = msgs.map(m => {
      const isMe = m.from === 'me';
      return `
        <div class="msg-bubble ${isMe ? 'me' : 'them'}">
          <div class="bubble">${escHtml(m.text)}</div>
          <div class="bubble-meta">
            ${isMe ? 'Vous' : escHtml(m.fromName)} Â· ${timeStr(m.ts)}
            <span class="e2e-badge">ğŸ” E2E</span>
          </div>
        </div>`;
    }).join('');

    container.scrollTop = container.scrollHeight;
  } catch (e) {}
}

async function sendMessage() {
  if (!selectedPeer) return;
  const input = document.getElementById('chatInput');
  const text  = input.value.trim();
  if (!text) return;
  input.value = '';

  try {
    await fetch('/api/chat/send', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ targetNodeId: selectedPeer.nodeId, message: text })
    });
    await loadMessages(selectedPeer.nodeId);
  } catch (e) {
    toast('Envoi Ã©chouÃ©', 'error');
  }
}

// â”€â”€ Fichiers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshFiles() {
  try {
    const res  = await fetch('/api/files');
    const data = await res.json();

    const localEl   = document.getElementById('localFiles');
    const networkEl = document.getElementById('networkFiles');

    localEl.innerHTML = data.local.length === 0
      ? `<div class="no-peers-msg" style="grid-column:1/-1">Vous n'avez pas encore partagÃ© de fichier</div>`
      : data.local.map(f => `
          <div class="file-card">
            <span class="badge badge-local">PartagÃ©</span>
            <div class="file-card-icon">${fileIcon(f.file_name)}</div>
            <div class="file-card-name">${escHtml(f.file_name)}</div>
            <div class="file-card-meta">${fmt(f.total_size)} Â· ${f.total_chunks} blocs</div>
          </div>`).join('');

    networkEl.innerHTML = data.network.length === 0
      ? `<div class="no-peers-msg" style="grid-column:1/-1">Aucun fichier partagÃ© sur le rÃ©seau</div>`
      : data.network.map(f => `
          <div class="file-card"
            onclick="promptDownload('${escHtml(f.fileId)}','${escHtml(f.file_name)}','${fmt(f.total_size)}','${escHtml(f.ownerName)}')">
            <span class="badge badge-network">RÃ©seau</span>
            <div class="file-card-icon">${fileIcon(f.file_name)}</div>
            <div class="file-card-name">${escHtml(f.file_name)}</div>
            <div class="file-card-meta">${fmt(f.total_size)}</div>
            <div class="file-card-owner">Par ${escHtml(f.ownerName)}</div>
          </div>`).join('');
  } catch (e) {}
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('shareZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) shareFile(file.path || file.name);
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) shareFile(file.path || file.name);
  e.target.value = '';
}

async function shareFile(filePath) {
  toast('PrÃ©paration du fichier...', 'info');
  try {
    const res  = await fetch('/api/files/share', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filePath })
    });
    const data = await res.json();
    if (data.success) {
      toast(`âœ… "${data.file.name}" partagÃ© sur le rÃ©seau`, 'success');
      refreshFiles();
    } else {
      toast('Erreur : ' + data.error, 'error');
    }
  } catch (e) {
    toast('Erreur lors du partage', 'error');
  }
}

function promptDownload(fileId, name, size, ownerName) {
  pendingDl = { fileId, name };
  document.getElementById('downloadModalDesc').textContent =
    `"${name}" (${size}) â€” partagÃ© par ${ownerName}`;
  document.getElementById('downloadModal').classList.add('open');
}

function closeModal() {
  document.getElementById('downloadModal').classList.remove('open');
  pendingDl = null;
}

async function confirmDownload() {
  if (!pendingDl) return;
  closeModal();

  const { fileId, name } = pendingDl;
  const card  = document.getElementById('progressCard');
  const fill  = document.getElementById('progressFill');
  const label = document.getElementById('progressLabel');
  document.getElementById('progressTitle').textContent = name;

  card.style.display = 'block';
  fill.style.width   = '0%';
  label.textContent  = 'RÃ©cupÃ©ration des donnÃ©es...';

  let prog = 0;
  const iv = setInterval(() => {
    prog = Math.min(prog + Math.random() * 5, 88);
    fill.style.width = prog + '%';
  }, 400);

  try {
    const res  = await fetch('/api/files/download', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ fileId })
    });
    const data = await res.json();
    clearInterval(iv);

    if (data.success) {
      fill.style.width  = '100%';
      label.textContent = `âœ… TÃ©lÃ©chargÃ© dans le dossier downloads/`;
      toast(`"${name}" tÃ©lÃ©chargÃ© !`, 'success');
      setTimeout(() => { card.style.display = 'none'; }, 5000);
      refreshFiles();
    } else {
      fill.style.width  = '0%';
      label.textContent = 'âŒ ' + data.error;
      toast('TÃ©lÃ©chargement Ã©chouÃ©', 'error');
    }
  } catch (e) {
    clearInterval(iv);
    label.textContent = 'âŒ Erreur rÃ©seau';
    toast('Erreur rÃ©seau', 'error');
  }
}

// â”€â”€ IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function askAI() {
  const input = document.getElementById('aiInput');
  const query = input.value.trim();
  if (!query) return;
  input.value = '';

  const container = document.getElementById('aiMessages');

  container.insertAdjacentHTML('beforeend', `
    <div class="msg-bubble me">
      <div class="bubble">${escHtml(query)}</div>
      <div class="bubble-meta">Vous Â· maintenant</div>
    </div>`);

  const loadId = 'load-' + Date.now();
  container.insertAdjacentHTML('beforeend', `
    <div class="msg-bubble them" id="${loadId}">
      <div class="bubble">â³ RÃ©flexion...</div>
    </div>`);
  container.scrollTop = container.scrollHeight;

  try {
    const res  = await fetch('/api/ai/ask', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query })
    });
    const data = await res.json();
    document.getElementById(loadId)?.remove();

    container.insertAdjacentHTML('beforeend', `
      <div class="msg-bubble them">
        <div class="bubble">${escHtml(data.text || ('âš ï¸ ' + (data.error || 'Erreur')))}</div>
        <div class="bubble-meta">Assistant Â· ${timeStr(Date.now())}</div>
      </div>`);
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    document.getElementById(loadId)?.remove();
    toast('IA inaccessible', 'error');
  }
}

// â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolling() {
  refreshNetwork();
  setInterval(refreshNetwork, 3000);
  setInterval(() => {
    if (selectedPeer && currentNav === 'messages') {
      loadMessages(selectedPeer.nodeId);
    }
  }, 2000);
}

// â”€â”€ VÃ©rification au chargement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', async () => {
  try {
    const res  = await fetch('/api/auth/check');
    const data = await res.json();
    if (data.registered) {
      switchAuthTab('login');
      document.getElementById('login-name-hint').textContent =
        `Bonjour ${data.name} ğŸ‘‹ â€” entrez votre mot de passe`;
    }
  } catch (e) {}
});
</script>
</body>
</html>